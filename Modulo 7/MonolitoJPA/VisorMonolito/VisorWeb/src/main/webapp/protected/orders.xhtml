<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui">

<h:head></h:head>
<body>

	<ui:composition template="/WEB-INF/templates/master.xhtml">
		<ui:define name="content">
			<h:form id="frm">
				<p:growl id="men" />
				<p:toolbar>
					<f:facet name="right">
						<p:commandButton value="Nuevo" icon="icon_document"
							process="@this" actionListener="#{orderController.resetForm()}"
							update="@form" />
						<p:commandButton value="Guardar" icon="icon_save"
							process="@this :frm:tabVieGen:panGriCabOrder"
							actionListener="#{orderController.saveOrder()}"
							update=":frm:men :frm:tabVieGen:panGriCabOrder" />
					</f:facet>
					
					<f:facet name="left">
						<p:outputLabel value="Administración de Ordenes" />
					</f:facet>
					
				</p:toolbar>
				<br></br>
				<p:tabView id="tabVieGen">
					<p:tab title="Generar Orden">
						<p:panelGrid id="panGriCabOrder" columns="4" style="width:100%">

							<p:outputLabel value="Fecha:" />
							<p:calendar id="calFecFac"
								value="#{orderController.order.createAt}" />
								
							<p:outputLabel for="txtIdeCli" value="Dni Cliente:" />
							<h:panelGroup>
								<p:inputText id="txtIdeCli" maxlength="13" required="true"
									value="#{orderController.customer.dni}" />
								<p:commandButton icon="ui-icon-search"
									process="@this :frm:tabVieGen:txtIdeCli"
									actionListener="#{orderController.findCustomerByDni()}"
									update=":frm:tabVieGen:txtNomCli
							:frm:tabVieGen:txaDirCli 
							:frm:men" />
							</h:panelGroup>
							
							<p:outputLabel value="Nombres:" />
							<p:inputText id="txtNomCli" readonly="true"
								value="#{orderController.customer.name}" />
							<p:outputLabel value="Dirección" />
							<p:inputTextarea id="txaDirCli" readonly="true"
								value="#{orderController.customer.address}" />
						</p:panelGrid>
						
						<br></br>
						<p:toolbar>
							<f:facet name="right">
								<p:commandButton value="Añadir" icon="ui-icon-plus"
									onclick="PF('diaAnaDetOrder').show();" />
								<p:commandButton value="Eliminar" icon="ui-icon-trash"
									onclick="PF('diaConEliDetOrder').show();" />
							</f:facet>
						</p:toolbar>
						
						<p:dataTable id="datTabDetOrder"
							value="#{orderController.detailOrders}" var="detOr"
							selectionMode="single" rowKey="#{detOr.id}">
							<p:ajax event="rowSelect"
								listener="#{orderController.detailOrderSel}" />
							<p:column headerText="Producto">
								<p:outputLabel value="#{detOr.product.name}" />
							</p:column>
							<p:column headerText="Cantidad">
								<p:outputLabel value="#{detOr.quantity}" />
							</p:column>
							<p:column headerText="Precio">
								<p:outputLabel value="#{detOr.price}" />
							</p:column>
							<p:column headerText="SubTotal">
								<p:outputLabel value="#{detOr.subTotal}" />
							</p:column>
						</p:dataTable>


						<p:dialog widgetVar="diaAnaDetOrder" header="Añadir Detalle"
							width="450" height="400">
							<p:toolbar>
								<f:facet name="right">
									<p:commandButton value="Guardar"
										process="@this :frm:tabVieGen:panGriAnaDetOrder"
										actionListener="#{orderController.addProductToDetail()}"
										update=":frm:tabVieGen:panGriAnaDetOrder :frm:tabVieGen:datTabDetOrder :frm:men"
										oncomplete="PF('diaAnaDetOrder').hide();" />
									<p:commandButton value="Cancelar" process="@this"
										update=":frm:tabVieGen:panGriAnaDetOrder"
										oncomplete="PF('diaAnaDetOrder').hide();" />
								</f:facet>
							</p:toolbar>
							<br />

							<p:panelGrid id="panGriAnaDetOrder" columns="2" style="width:100%">

								<p:outputLabel value="Producto:" for="atxtProDetOrder" />

								<p:selectOneMenu id="atxtProDetOrder" required="true"
									effect="drop" value="#{orderController.product}"
									converter="omnifaces.SelectItemsConverter" filter="true"
									filterMatchMode="contains">
									<f:selectItem itemLabel="Seleccione una opción"
										noSelectionOption="true" itemValue="" />
									<f:selectItems value="#{orderController.products}" var="pro"
										itemLabel="#{pro.name}" itemValue="#{pro}" />
									<p:ajax event="itemSelect"
										listener="#{orderController.updatePriceProduct}"
										update="frm:tabVieGen:spiPreProDetOrder" />
								</p:selectOneMenu>

								<p:outputLabel value="Precio:" for="spiPreProDetOrder" />
								<p:inputText id="spiPreProDetOrder" readonly="true"
									value="#{orderController.detailOrder.price}" />
								<p:outputLabel value="Cantidad:" for="spiCanDetOrder" />
								<p:inputText id="spiCanDetOrder" required="true"
									value="#{orderController.detailOrder.quantity}">
									<p:ajax event="keyup"
										listener="#{orderController.calculateSutTotalDetail}"
										update=":frm:tabVieGen:spiTotDetOrder" />
								</p:inputText>
								<p:outputLabel value="Total:" for="spiTotDetOrder" />
								<p:spinner id="spiTotDetOrder" readonly="true"
									value="#{orderController.detailOrder.subTotal}" />

							</p:panelGrid>
						</p:dialog>
					</p:tab>
					<p:tab title="Ordenes">
						<p:panelGrid id="panGriBusOrder" columns="4" style="width:100%">
							<p:outputLabel value="Buscar Por:" for="txtBusPor" />
							<p:selectOneMenu id="cmbBusPor"
								value="#{orderController.searchBy}">
								<f:selectItem itemLabel="Seleccione una opción" />
								<f:selectItem itemLabel="CLIENTE" itemValue="CLIENTE" />
								<f:selectItem itemLabel="ESTADO" itemValue="ESTADO" />
								<f:selectItem itemLabel="FECHA" itemValue="FECHA" />
							</p:selectOneMenu>
							<p:inputText id="txtBusPor" value="#{orderController.valueSearch}" />
							<p:commandButton icon="ui-icon-search"
								process="@this :frm:tabVieGen:panGriBusOrder"
								actionListener="#{orderController.searhOrder}"
								update=":frm:men :frm:tabVieGen:datTabOrder" />
						</p:panelGrid>
						<br></br>
						<p:dataTable id="datTabOrder" value="#{orderController.orders}"
							var="o" selectionMode="single" rowKey="#{o.id}">
							<p:ajax event="rowSelect"
								listener="#{orderController.selectOrder}" />
							
							<p:column headerText="Fecha">
								<p:outputLabel value="#{o.createAt}">
									<f:convertDateTime pattern="yyyy-MM-dd" />
								</p:outputLabel>
							</p:column>
							<p:column headerText="Cliente">
								<p:outputLabel
									value="#{o.customer.name}" />
							</p:column>
							<p:column headerText="Total">
								<p:outputLabel value="#{o.total}" />
							</p:column>
							<p:column headerText="Detalles">
								<p:dataList value="#{o.items}" var="detOr">
									<p:outputLabel value="#{detOr}" />
								</p:dataList>
							</p:column>
							<p:column headerText="Estado">
								<p:outputLabel
									value="#{o.state eq '1' ? 'EMITIDO' : 'ANULADO'}" />
							</p:column>
						</p:dataTable>
					</p:tab>

				</p:tabView>
			</h:form>
		</ui:define>
	</ui:composition>

</body>
</html>